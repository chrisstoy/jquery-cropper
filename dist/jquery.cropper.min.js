/*!
 * Simple Image Cropper that works on Desktop and Mobile
 * This plugin widget depends on jQuery, jQueryUI, and FabricJS.
 * Copyright 2016 Chris Stoy
 * Licensed under the MIT license
 *
 * see https://learn.jquery.com/plugins/stateful-plugins-with-widget-factory/
 */
!function(e){"use strict";e.widget("cstoy.cropper",{_model:{cropData:{u:0,v:0,width:1,height:1},imageUrl:null,handleSize:10,handleColor:"white",lineColor:"blue",gridColor:"white",gridWidth:1,lineWidth:1,minCropSizeUV:.1,gridHideDelay:500,cropBorderColor:"rgba(255,255,255,0.5)",cropAreaColor:"rgba(0,0,0,0)"},_rawImage:null,cropData:function(e){return void 0===e?this._model.cropData:(this._model.cropData=e,this._update(),this._model.cropData)},imageCrop:function(e){if(void 0===e){var t={left:this._model.cropData.u*this._rawImage.width,top:this._model.cropData.v*this._rawImage.height,width:this._model.cropData.width*this._rawImage.width,height:this._model.cropData.height*this._rawImage.height};return t}return this._model.cropData=e,this._update(),this._model.cropData},imageSize:function(e){if(void 0===e)return{width:this._rawImage.width,height:this._rawImage.height};throw"Error: imageSize is read-only"},_setOption:function(e,t){this._model[e]=t,this._updateHandlePosition()},_createHandle:function(e){var t=new fabric.Circle({left:e.x,top:e.y,fill:this._model.handleColor,radius:this._model.handleSize,strokeWidth:this._model.lineWidth,stroke:this._model.lineColor});return t.handleId=e.id,t.originX="center",t.originY="center",t.hasRotatingPoint=!1,t.hasControls=!1,t.lockScalingX=!0,t.lockScalingY=!0,t.lockUniScaling=!0,t.lockRotation=!0,this._model.canvas.add(t),t},_createOverlayRect:function(e){var t=new fabric.Rect({left:e.left,top:e.top,width:e.width,height:e.height,fill:e.fill,strokeWidth:this._model.lineWidth,stroke:this._model.lineColor});return t.handleId=e.id,t.hasRotatingPoint=!1,t.hasControls=!1,t.lockScalingX=!0,t.lockScalingY=!0,t.lockUniScaling=!0,t.lockRotation=!0,this._model.canvas.add(t),t},_createLine:function(e){var t=new fabric.Line(e,{stroke:this._model.gridColor,strokeWidth:this._model.gridWidth,selectable:!1});return this._model.canvas.add(t),t},_doAreaClip:function(e){var t=this._model.image.left,i=this._model.image.top,l=this._model.handles.tr.left-this._model.handles.tl.left,o=this._model.image.height;e.beginPath(),e.rect(this._model.handles.tl.left,i,l,this._model.handles.tl.top-i),e.rect(this._model.handles.tl.left,this._model.handles.bl.top,l,this._model.image.height-(this._model.handles.bl.top-i)),e.rect(t,i,this._model.handles.tl.left-t,o),e.rect(this._model.handles.tr.left,i,this._model.image.width-(this._model.handles.tr.left-t),o),e.fill()},_toUV:function(e){return{u:(e.left-this._model.image.left)/this._model.image.getWidth(),v:(e.top-this._model.image.top)/this._model.image.getHeight()}},_fromUV:function(e){return{left:e.u*this._model.image.getWidth()+this._model.image.left,top:e.v*this._model.image.getHeight()+this._model.image.top}},_updateHandlePosition:function(e){var t=this._toUV(e),i={u:Math.min(Math.max(t.u,0),1),v:Math.min(Math.max(t.v,0),1)},l={u:this._model.cropData.u,v:this._model.cropData.v},o={u:this._model.cropData.u+this._model.cropData.width,v:this._model.cropData.v+this._model.cropData.height};switch(e.handleId){case"tl":l.u=i.u,l.v=i.v;break;case"tr":o.u=i.u,l.v=i.v;break;case"bl":l.u=i.u,o.v=i.v;break;case"br":o.u=i.u,o.v=i.v;break;case"rect":l.u=i.u,l.v=i.v,o.u=l.u+this._model.cropData.width,o.v=l.v+this._model.cropData.height}(o.u-l.u<this._model.minCropSizeUV||o.u>1)&&(l.u=this._model.cropData.u,o.u=this._model.cropData.u+this._model.cropData.width),(o.v-l.v<this._model.minCropSizeUV||o.v>1)&&(l.v=this._model.cropData.v,o.v=this._model.cropData.v+this._model.cropData.height),this._model.cropData.u=l.u,this._model.cropData.v=l.v,this._model.cropData.width=o.u-l.u,this._model.cropData.height=o.v-l.v,this._update()},_update:function(){this._trigger("changed",null,this._model.cropData);var e={u:this._model.cropData.u+this._model.cropData.width,v:this._model.cropData.v+this._model.cropData.height};this._model.handles.tl.set(this._fromUV({u:this._model.cropData.u,v:this._model.cropData.v})).setCoords(),this._model.handles.tr.set(this._fromUV({u:e.u,v:this._model.cropData.v})).setCoords(),this._model.handles.bl.set(this._fromUV({u:this._model.cropData.u,v:e.v})).setCoords(),this._model.handles.br.set(this._fromUV({u:e.u,v:e.v})).setCoords();var t={left:this._model.handles.tl.left,top:this._model.handles.tl.top,width:this._model.handles.br.left-this._model.handles.tl.left,height:this._model.handles.br.top-this._model.handles.tl.top};this._model.handles.area.set(t).setCoords(),this._updateGridLines(),this._showGridLines(!0,this._model.gridHideDelay),this._model.canvas.renderAll()},_updateGridLines:function(){var e=this._model.handles.tl.left+(this._model.handles.br.left-this._model.handles.tl.left)/3,t=this._model.handles.tl.left+2*(this._model.handles.br.left-this._model.handles.tl.left)/3,i=this._model.handles.tl.top+(this._model.handles.br.top-this._model.handles.tl.top)/3,l=this._model.handles.tl.top+2*(this._model.handles.br.top-this._model.handles.tl.top)/3;this._model.handles.h1.set({x1:this._model.handles.tl.left,y1:i,x2:this._model.handles.br.left,y2:i}),this._model.handles.h2.set({x1:this._model.handles.tl.left,y1:l,x2:this._model.handles.br.left,y2:l}),this._model.handles.v1.set({x1:e,y1:this._model.handles.tl.top,x2:e,y2:this._model.handles.br.top}),this._model.handles.v2.set({x1:t,y1:this._model.handles.tl.top,x2:t,y2:this._model.handles.br.top})},_showGridLines:function(e,t){if(this._model.handles.h1.setVisible(e),this._model.handles.h2.setVisible(e),this._model.handles.v1.setVisible(e),this._model.handles.v2.setVisible(e),this.hideGridlinesTimer&&(window.clearTimeout(this.hideGridlinesTimer),this.hideGridlinesTimer=null),e&&t>0){var i=this;this.hideGridlinesTimer=setTimeout(function(){i._showGridLines(!1),i.hideGridlinesTimer=null,i._model.canvas.renderAll()},t)}},_onImageLoad:function(){this._model.image=new fabric.Image(this._rawImage);var e=this.element.width(),t=this.element.height(),i=e-2*this._model.handleSize,l=t-4*this._model.handleSize,o=this.element.find("canvas")[0];this._model.canvas=new fabric.Canvas(o),this._model.canvas.setDimensions({width:e,height:t}),this._model.canvas.clear();var h=Math.min(i/this._model.image.getWidth(),l/this._model.image.getHeight()),s=h*this._model.image.getWidth(),a=h*this._model.image.getHeight();this._model.image.setWidth(s),this._model.image.setHeight(a),this._model.image.hasControls=!1,this._model.image.hasBorders=!1,this._model.image.lockMovementX=!0,this._model.image.lockMovementY=!0,this._model.image.lockScalingX=!0,this._model.image.lockScalingY=!0,this._model.image.lockUniScaling=!0,this._model.image.lockRotation=!0,this._model.canvas.add(this._model.image),this._model.image.center(),this._model.handles={tl:this._createHandle({x:this._model.image.left,y:this._model.image.top,id:"tl"}),bl:this._createHandle({x:this._model.image.left,y:this._model.image.top+this._model.image.height,id:"bl"}),tr:this._createHandle({x:this._model.image.left+this._model.image.width,y:this._model.image.top,id:"tr"}),br:this._createHandle({x:this._model.image.left+this._model.image.width,y:this._model.image.top+this._model.image.height,id:"br"}),area:this._createOverlayRect({fill:this._model.cropAreaColor,id:"rect"}),h1:this._createLine([0,0,0,0]),h2:this._createLine([0,0,0,0]),v1:this._createLine([0,0,0,0]),v2:this._createLine([0,0,0,0])},this._showGridLines(!1),this._updateGridLines();var d=this;this._model.overlay=this._createOverlayRect({fill:this._model.cropBorderColor}),this._model.overlay.lockMovementX=!0,this._model.overlay.lockMovementY=!0,this._model.overlay.clipTo=function(e){d._doAreaClip(e)},this._model.canvas.sendToBack(this._model.image),this._model.canvas.bringToFront(this._model.overlay),this._model.canvas.bringToFront(this._model.handles.area),this._model.canvas.bringToFront(this._model.handles.h1),this._model.canvas.bringToFront(this._model.handles.h2),this._model.canvas.bringToFront(this._model.handles.v1),this._model.canvas.bringToFront(this._model.handles.v2),this._model.canvas.bringToFront(this._model.handles.tl),this._model.canvas.bringToFront(this._model.handles.tr),this._model.canvas.bringToFront(this._model.handles.bl),this._model.canvas.bringToFront(this._model.handles.br),this._model.canvas.setActiveObject(this._model.handles.area),this._model.canvas.on("object:moving",function(e){var t=e.target;t.handleId&&d._updateHandlePosition(t)}),this._trigger("ready",null,null)},_create:function(){this._model=e.extend(this._model,this.options),this._rawImage=new Image,this._rawImage.crossOrigin="Anonymous",this._rawImage.src=this._model.imageUrl;var t=this;this._rawImage.onload=function(){t._onImageLoad()}},_destroy:function(){this._model.canvas.dispose(),this._model.canvas=null,delete this._rawImage}})}(jQuery);